<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Bulletin Board</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <%- include('partials/nav') %>
  <main class="app">
    <header class="header">
      <div>
		<h1>Home Bulletin Board</h1>
      </div>
      <div class="header-right">
        <section class="connection">
          <span class="connection-text">Access via:</span>
          <span class="connection-url"><%= boardUrl %></span>
        </section>
      </div>
    </header>

    <section class="columns">
      <section class="column-group">
        <section class="column">
          <h2>Groceries</h2>
          <ul>
            <% board.groceries.forEach(function(item) { %>
              <li><span class="bullet">‚Ä¢</span> <%= item %></li>
            <% }) %>
          </ul>
        </section>

        <section class="column">
          <h2>Other Shopping</h2>
          <ul>
            <% board.shopping.forEach(function(item) { %>
              <li><span class="bullet">‚Ä¢</span> <%= item %></li>
            <% }) %>
          </ul>
        </section>
      </section>

      <section class="column-group">
        <section class="column">
          <h2>Reminders</h2>
          <ul>
            <% board.reminders.forEach(function(item) { %>
              <li><span class="bullet">‚Ä¢</span> <%= item %></li>
            <% }) %>
          </ul>
        </section>

        <section class="column">
          <h2>Chores</h2>
          <%
            const choresByUser = {};
            board.chores.forEach(function(chore, index) {
              const user = users.find(function(u) { return u.id === chore.userId; }) || null;
              const key = user ? String(user.id) : 'unassigned';
              if (!choresByUser[key]) {
                choresByUser[key] = { user: user, chores: [] };
              }
              choresByUser[key].chores.push({ chore: chore, index: index });
            });

            Object.keys(choresByUser).forEach(function(key) {
              const group = choresByUser[key];
          %>
            <div class="chore-group">
              <% if (group.user) { %>
                <div class="chore-group-header">
                  <span class="chore-user-dot" data-user-color="<%= group.user.color %>"></span>
                  <span class="chore-user-label"><%= group.user.name %></span>
                </div>
              <% } %>
              <ul>
                <% group.chores.forEach(function(entry) { %>
                  <% const chore = entry.chore; const idx = entry.index; %>
                  <li data-chore-index="<%= idx %>">
                    <span class="chore-text<%= chore.completed ? ' chore-text--completed' : '' %>">
                      <%= chore.text %>
                    </span>
                    <% if (group.user) { %>
                      <span
                        class="chore-checkbox"
                        data-user-name="<%= group.user.name %>"
                        data-chore-index="<%= idx %>"
                        aria-hidden="true"
                      ><%= chore.completed ? '‚òë' : '‚òê' %></span>
                    <% } %>
                  </li>
                <% }); %>
              </ul>
            </div>
          <% }); %>
        </section>
      </section>
    </section>

    <section class="messages">
      <h2>Messages</h2>
        <ul class="message-list">
          <% messages.forEach(function(msg) { %>
            <li class="message-item">
              <div class="message-user" style="--user-color: <%= msg.userColor %>">
                <span class="dot"></span>
                <span class="name"><%= msg.userName %></span>
                <span class="time"><%= msg.displayTime %></span>
              </div>
              <div class="message-text"><%= msg.text %></div>
            </li>
          <% }) %>
        </ul>
        <p class="read-only">This board is currently read‚Äëonly. Editing and logins will be added later.</p>
      </div>
    </section>

  </main>
  <script>
    (function () {
      const STORAGE_KEY = 'homeboard-theme';
      const USER_KEY = 'homeboard-user-name';
      const root = document.documentElement;

      function applyTheme(theme) {
        root.dataset.theme = theme;
        const label = document.querySelector('.theme-toggle__label');
        const icon = document.querySelector('.theme-toggle__icon');
        if (!label || !icon) return;
        if (theme === 'light') {
          label.textContent = 'Light';
          icon.textContent = '‚òÄÔ∏è';
        } else {
          label.textContent = 'Dark';
          icon.textContent = 'üåô';
        }
      }

      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored === 'light' || stored === 'dark') {
        applyTheme(stored);
      } else if (
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: light)').matches
      ) {
        applyTheme('light');
      } else {
        applyTheme('dark');
      }

      const btn = document.querySelector('.theme-toggle');
      if (btn) {
        btn.addEventListener('click', function () {
          const next = root.dataset.theme === 'light' ? 'dark' : 'light';
          applyTheme(next);
          localStorage.setItem(STORAGE_KEY, next);
        });
      }

      function applyUser() {
        const name = localStorage.getItem(USER_KEY);
        const loginLink = document.getElementById('nav-login-link');
        const logoutBtn = document.getElementById('nav-logout-button');
        const trimmedName = name ? name.trim() : '';
        const hasName = !!trimmedName;

        if (loginLink) {
          loginLink.textContent = hasName ? trimmedName : 'Login';
        }

        if (logoutBtn) {
          logoutBtn.style.display = hasName ? 'inline-flex' : 'none';
        }

        const checkboxes = document.querySelectorAll('.chore-checkbox');
        checkboxes.forEach(function (el) {
          const ownerName = (el.getAttribute('data-user-name') || '').trim();
          if (hasName && ownerName.toLowerCase() === trimmedName.toLowerCase()) {
            el.style.display = 'inline-block';
          } else {
            el.style.display = 'none';
          }
        });
      }

      applyUser();

      const choreCheckboxes = document.querySelectorAll('.chore-checkbox');
      choreCheckboxes.forEach(function (el) {
        el.addEventListener('click', function () {
          const name = localStorage.getItem(USER_KEY);
          const trimmedName = name ? name.trim() : '';
          const hasName = !!trimmedName;
          const ownerName = (el.getAttribute('data-user-name') || '').trim();

          if (!hasName || ownerName.toLowerCase() !== trimmedName.toLowerCase()) {
            return;
          }

          const indexAttr = el.getAttribute('data-chore-index');
          if (!indexAttr) {
            return;
          }

          const index = Number(indexAttr);
          if (!Number.isFinite(index)) {
            return;
          }

          const isCompleted = el.textContent === '‚òë';

          fetch('/api/chores/update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              index: index,
              userName: trimmedName,
            }),
          })
            .then(function (response) {
              if (!response.ok) {
                throw new Error('Failed to complete chore');
              }
              return response.json();
            })
            .then(function () {
              el.textContent = isCompleted ? '‚òê' : '‚òë';
              const listItem = el.closest('li');
              if (listItem) {
                const textSpan = listItem.querySelector('.chore-text');
                if (textSpan) {
                  if (isCompleted) {
                    textSpan.classList.remove('chore-text--completed');
                  } else {
                    textSpan.classList.add('chore-text--completed');
                  }
                }
              }
            })
            .catch(function () {
              // For now, ignore errors silently on the UI
            });
        });
      });

      const choreUserDots = document.querySelectorAll('.chore-user-dot');
      choreUserDots.forEach(function (dot) {
        const color = dot.getAttribute('data-user-color');
        if (color) {
          dot.style.backgroundColor = color;
        }
      });

      const choreTexts = document.querySelectorAll('.chore-text');
      choreTexts.forEach(function (textEl) {
        textEl.addEventListener('click', function () {
          const listItem = textEl.closest('li');
          if (!listItem) {
            return;
          }

          const checkbox = listItem.querySelector('.chore-checkbox');
          if (!checkbox) {
            return;
          }

          checkbox.click();
        });
      });

      const logoutBtn = document.getElementById('nav-logout-button');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          localStorage.removeItem(USER_KEY);
          applyUser();
        });
      }

      // Auto-refresh the board every 60 seconds to pick up changes.
      const ONE_MINUTE_MS = 60_000;
      setInterval(function () {
        window.location.reload();
      }, ONE_MINUTE_MS);
    })();
  </script>
</body>
</html>
